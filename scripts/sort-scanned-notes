#!/bin/bash
# Sort and organize scanned notes from Inbox to proper course folders
# Usage: sort-scanned-notes [note-file]

set -euo pipefail

# Configuration
VAULT_PATH="/mnt/vol_ii/Obsidian/University of Idaho"
INBOX_PATH="$VAULT_PATH/00 - Inbox"
DOCUMENTED_PATH="$VAULT_PATH/Documented"

# Colors
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
PURPLE='\033[0;35m'
NC='\033[0m'

print_info() { echo -e "${CYAN}[INFO]${NC} $1"; }
print_success() { echo -e "${GREEN}[✓]${NC} $1"; }
print_warning() { echo -e "${YELLOW}[!]${NC} $1"; }
print_error() { echo -e "${RED}[✗]${NC} $1"; }
print_question() { echo -e "${PURPLE}[?]${NC} $1"; }

show_usage() {
    cat << EOF
Usage: sort-scanned-notes [OPTIONS] [FILE]

Sort and organize scanned notes from Inbox to proper course folders.

OPTIONS:
    -a, --auto              Auto-sort all scanned notes in Inbox
    -i, --interactive       Interactive mode (default)
    -h, --help              Show this help message

EXAMPLES:
    sort-scanned-notes                           # Interactive: shows all inbox notes
    sort-scanned-notes "Lab Notes.md"            # Sort specific note
    sort-scanned-notes -a                        # Auto-sort all (based on metadata)

SORTING LOGIC:
    - Reads 'course' and 'tags' from YAML frontmatter
    - Moves to course folder if course specified
    - Otherwise prompts for destination
    - Updates wikilinks and MOC references

EOF
}

# Get all scanned notes in inbox and documented
get_scanned_notes() {
    {
        find "$INBOX_PATH" -maxdepth 1 -name "*.md" -type f -exec grep -l "type: scanned-notes" {} \; 2>/dev/null
        find "$DOCUMENTED_PATH" -maxdepth 1 -name "*.md" -type f -exec grep -l "type: scanned-notes" {} \; 2>/dev/null
    } | sort
}

# Extract frontmatter field
get_yaml_field() {
    local file="$1"
    local field="$2"

    awk -v field="$field" '
        /^---$/ { in_yaml = !in_yaml; next }
        in_yaml && $0 ~ "^" field ":" {
            sub("^" field ": *", "")
            gsub(/^["\047]|["\047]$/, "")
            print
            exit
        }
    ' "$file"
}

# Find course directory
find_course_dir() {
    local course="$1"
    find "$VAULT_PATH" -maxdepth 1 -type d -name "${course}*" | head -1
}

# Sort a single note
sort_note() {
    local note_file="$1"
    local note_name=$(basename "$note_file")

    print_info "Processing: $note_name"

    # Extract metadata
    local course=$(get_yaml_field "$note_file" "course")
    local title=$(get_yaml_field "$note_file" "title")
    local tags=$(get_yaml_field "$note_file" "tags")

    echo "  Title: $title"
    echo "  Course: ${course:-[none]}"
    echo "  Tags: ${tags:-[none]}"

    # Determine destination
    local dest_dir=""

    if [ -n "$course" ]; then
        dest_dir=$(find_course_dir "$course")

        if [ -n "$dest_dir" ]; then
            print_success "Found course folder: $(basename "$dest_dir")"
        else
            print_warning "Course folder not found for: $course"
        fi
    fi

    # Interactive destination selection if needed
    if [ -z "$dest_dir" ]; then
        print_question "Where should this note go?"

        # List available course folders
        echo ""
        echo "Available course folders:"
        local course_dirs=($(find "$VAULT_PATH" -maxdepth 1 -type d \( -name "FOR*" -o -name "FIR*" -o -name "ENT*" -o -name "ECON*" -o -name "BIO*" -o -name "ASM*" \) | sort))

        for i in "${!course_dirs[@]}"; do
            echo "  $((i+1)). $(basename "${course_dirs[$i]}")"
        done

        echo "  0. Keep in Inbox (skip)"
        echo ""

        read -p "Select number: " selection

        if [ "$selection" = "0" ]; then
            print_info "Skipping (keeping in Inbox)"
            return 0
        elif [ "$selection" -ge 1 ] && [ "$selection" -le "${#course_dirs[@]}" ]; then
            dest_dir="${course_dirs[$((selection-1))]}"
        else
            print_error "Invalid selection"
            return 1
        fi
    fi

    # Move the note
    local dest_file="$dest_dir/$note_name"

    if mv "$note_file" "$dest_file"; then
        print_success "Moved to: $(basename "$dest_dir")/$note_name"

        # Update course field in frontmatter if not set
        if [ -z "$course" ]; then
            local course_code=$(basename "$dest_dir" | grep -oP '^[A-Z]+[0-9]+')
            if [ -n "$course_code" ]; then
                # Add course field to frontmatter
                sed -i "/^tags:/a course: $course_code" "$dest_file"
                print_info "Added course: $course_code to frontmatter"
            fi
        fi

        return 0
    else
        print_error "Failed to move note"
        return 1
    fi
}

# Main logic
INTERACTIVE=true
AUTO_MODE=false
NOTE_FILE=""

# Parse arguments
if [ $# -eq 0 ]; then
    INTERACTIVE=true
else
    while [[ $# -gt 0 ]]; do
        case $1 in
            -a|--auto)
                AUTO_MODE=true
                INTERACTIVE=false
                shift
                ;;
            -i|--interactive)
                INTERACTIVE=true
                shift
                ;;
            -h|--help)
                show_usage
                exit 0
                ;;
            *)
                NOTE_FILE="$1"
                shift
                ;;
        esac
    done
fi

# Process notes
if [ -n "$NOTE_FILE" ]; then
    # Sort specific note
    if [ ! -f "$NOTE_FILE" ]; then
        NOTE_FILE="$INBOX_PATH/$NOTE_FILE"
    fi

    if [ -f "$NOTE_FILE" ]; then
        sort_note "$NOTE_FILE"
    else
        print_error "Note not found: $NOTE_FILE"
        exit 1
    fi

elif [ "$AUTO_MODE" = true ]; then
    # Auto-sort all scanned notes with course metadata
    print_info "Auto-sorting all scanned notes with course information..."

    scanned_notes=($(get_scanned_notes))

    if [ ${#scanned_notes[@]} -eq 0 ]; then
        print_info "No scanned notes found in Inbox"
        exit 0
    fi

    for note in "${scanned_notes[@]}"; do
        course=$(get_yaml_field "$note" "course")

        if [ -n "$course" ]; then
            sort_note "$note"
        else
            print_warning "Skipping $(basename "$note") - no course specified"
        fi

        echo ""
    done

else
    # Interactive mode - show all scanned notes
    print_info "Scanned notes in Inbox:"

    scanned_notes=($(get_scanned_notes))

    if [ ${#scanned_notes[@]} -eq 0 ]; then
        print_info "No scanned notes found in Inbox"
        exit 0
    fi

    echo ""
    for i in "${!scanned_notes[@]}"; do
        note="${scanned_notes[$i]}"
        title=$(get_yaml_field "$note" "title")
        course=$(get_yaml_field "$note" "course")

        echo "  $((i+1)). $title ${course:+($course)}"
    done

    echo "  0. Exit"
    echo ""

    read -p "Select note to sort: " selection

    if [ "$selection" = "0" ]; then
        exit 0
    elif [ "$selection" -ge 1 ] && [ "$selection" -le "${#scanned_notes[@]}" ]; then
        sort_note "${scanned_notes[$((selection-1))]}"
    else
        print_error "Invalid selection"
        exit 1
    fi
fi

print_success "✨ Done!"
