#!/bin/bash
# Test configuration changes safely
# Usage: test-config <config-file>

CONFIG_FILE="$1"

if [ -z "$CONFIG_FILE" ]; then
    echo "Usage: test-config <config-file>"
    echo ""
    echo "Examples:"
    echo "  test-config ~/.config/sway/config"
    echo "  test-config ~/.bashrc"
    echo "  test-config ~/.config/waybar/config"
    exit 1
fi

if [ ! -f "$CONFIG_FILE" ]; then
    echo "Error: Config file not found: $CONFIG_FILE"
    exit 1
fi

BACKUP_FILE="${CONFIG_FILE}.test-backup"

# Backup current config
cp "$CONFIG_FILE" "$BACKUP_FILE"
echo "Backed up to: $BACKUP_FILE"
echo ""

# Edit config
"${EDITOR:-nvim}" "$CONFIG_FILE"

# Ask if user wants to test
echo ""
read -p "Apply changes and reload? (y/N): " response
if [[ ! "$response" =~ ^[Yy]$ ]]; then
    echo "Changes not applied. Restoring backup..."
    cp "$BACKUP_FILE" "$CONFIG_FILE"
    rm "$BACKUP_FILE"
    echo "Backup restored. No changes made."
    exit 0
fi

# Reload based on config type
case "$CONFIG_FILE" in
    *sway/config*)
        echo "Reloading Sway..."
        swaymsg reload
        if [ $? -eq 0 ]; then
            echo "✓ Sway reloaded successfully"
        else
            echo "✗ Sway reload failed! Restoring backup..."
            cp "$BACKUP_FILE" "$CONFIG_FILE"
            swaymsg reload
            exit 1
        fi
        ;;
    *waybar/config*)
        echo "Restarting Waybar..."
        killall waybar
        sleep 0.5
        waybar &
        echo "✓ Waybar restarted"
        ;;
    *mako/config*)
        echo "Restarting Mako..."
        killall mako
        sleep 0.5
        mako &
        echo "✓ Mako restarted"
        ;;
    *.bashrc)
        echo "To test bashrc, run: source ~/.bashrc"
        ;;
    *)
        echo "Manual reload may be required for this config file"
        ;;
esac

echo ""
echo "Changes applied. Test your configuration."
echo ""
echo "If problems occur:"
echo "  Restore: cp $BACKUP_FILE $CONFIG_FILE"
echo "  Then reload the application"
echo ""
read -p "Keep changes? (Y/n): " response
if [[ "$response" =~ ^[Nn]$ ]]; then
    echo "Restoring backup..."
    cp "$BACKUP_FILE" "$CONFIG_FILE"

    # Reload again
    case "$CONFIG_FILE" in
        *sway/config*)
            swaymsg reload
            ;;
        *waybar/config*)
            killall waybar; waybar &
            ;;
        *mako/config*)
            killall mako; mako &
            ;;
    esac

    echo "Backup restored"
else
    echo "Changes kept"
fi

# Clean up backup
rm "$BACKUP_FILE"
